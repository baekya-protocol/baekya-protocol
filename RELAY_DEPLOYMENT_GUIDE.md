# 🚀 백야 프로토콜 중계서버 배포 가이드

## 📋 개요

백야 프로토콜은 **1대1 중계서버** 구조를 사용합니다:
- 각 검증자(풀노드)마다 **전용 중계서버 1개**를 배포
- 모든 중계서버는 **중앙 리스팅 서버**에 자동 등록
- 블록 생성 시 **모든 중계서버**에 동시 전파

## 🏗️ 시스템 구조

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   리스팅 서버    │◄──►│   중계서버 A    │◄──►│   풀노드 A      │
│  (중앙 관리)     │    │  (Railway)      │    │  (로컬)         │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         ▲                       ▲
         │                       │
         ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   중계서버 B    │    │   중계서버 C    │    │      ...        │
│  (Railway)      │    │  (Railway)      │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 🚀 배포 순서

### 1️⃣ 리스팅 서버 배포 (최초 1회만)

```powershell
# Railway CLI 설치 (Windows)
iwr -useb https://railway.app/install.ps1 | iex

# 또는 npm으로 설치
npm install -g @railway/cli

# Railway 로그인
railway login

# 리스팅 서버 배포
./deploy-listing.ps1
```

### 2️⃣ 중계서버 배포 (검증자마다 1개씩)

```powershell
# 중계서버 배포
./deploy-relay.ps1
```

**배포 시 입력 정보:**
- 🔒 **중계서버 비밀번호**: 8자 이상 (풀노드 연결 시 사용)
- 📍 **위치 좌표**: 예) `37.5665,126.9780` (서울)

### 3️⃣ 풀노드 연결

```bash
# 풀노드 실행
node server.js
```

**연결 시 입력 정보:**
- 🌐 **중계서버 URL**: `https://your-relay-xxxxx.railway.app`
- 🔒 **중계서버 비밀번호**: 배포 시 설정한 비밀번호
- 📍 **풀노드 위치**: 예) `37.5665,126.9780`

## 📊 동작 과정

### ✅ 연결 과정
1. 중계서버 배포 → Railway에서 URL 생성
2. 풀노드 실행 → 중계서버 URL/비밀번호 입력
3. 인증 성공 → 중계서버가 리스팅 서버에 자동 등록
4. 리스팅 서버 → 모든 중계서버에 목록 업데이트 전파

### 🔄 블록 전파 과정
1. 풀노드에서 블록 생성
2. 리스팅 서버에서 활성 중계서버 목록 조회
3. **모든 중계서버**에 블록 동시 전파
4. 각 중계서버 → 연결된 클라이언트들에게 블록 정보 전달

## 🛠️ 주요 API 엔드포인트

### 리스팅 서버
- `POST /api/register-relay` - 중계서버 등록
- `GET /api/relay-list` - 중계서버 목록 조회
- `GET /api/status` - 서버 상태 확인

### 중계서버
- `POST /api/auth` - 풀노드 인증
- `POST /api/relay-list-update` - 리스트 업데이트 수신
- `POST /api/block-propagation` - 블록 전파 수신
- `GET /api/relay-status` - 중계서버 상태

### 풀노드
- `GET /api/relay-servers` - 로컬 중계서버 목록
- `POST /api/relay-servers/register` - 중계서버 등록

## 🔧 환경 변수

### 중계서버 (Railway)
```env
NODE_ENV=production
PORT=$PORT
RELAY_PASSWORD=your-secure-password
RELAY_LOCATION=37.5665,126.9780
```

### 리스팅 서버 (Railway)
```env
NODE_ENV=production
PORT=$PORT
```

## 📈 확장성

- **중계서버**: 검증자 수만큼 무제한 확장 가능
- **리스팅 서버**: 1개로 모든 중계서버 관리
- **자동 등록**: 새 중계서버 배포 시 자동으로 네트워크 참여
- **장애 복구**: 중계서버 재시작 시 자동 재등록

## 🚨 주의사항

1. **리스팅 서버**는 반드시 **먼저 배포**해야 함
2. **중계서버 비밀번호**는 안전하게 보관
3. **위치 좌표**는 정확하게 입력 (네트워크 최적화용)
4. Railway **무료 플랜** 제한 고려 (월 500시간)

## 🔍 모니터링

### Railway 대시보드
- https://railway.app/dashboard
- 각 서버의 로그, 메트릭, 상태 확인

### 로그 확인
```bash
# 중계서버 로그
railway logs

# 실시간 로그
railway logs --follow
```

## 💡 팁

1. **중계서버 이름**을 구분 가능하게 설정
2. **비밀번호**는 복잡하게 설정 (보안)
3. **위치**는 실제 서버 위치와 비슷하게 설정
4. **Railway 프로젝트**를 폴더별로 정리

---

## 🎉 완료!

이제 **분산된 중계서버 네트워크**가 구축되었습니다! 🚀

각 검증자는 자신만의 중계서버를 가지고, 모든 중계서버는 서로 연결되어 블록체인 데이터를 효율적으로 전파합니다.
