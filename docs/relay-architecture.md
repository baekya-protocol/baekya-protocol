# 백야 프로토콜 릴레이 서버 아키텍처

## 개요

백야 프로토콜의 새로운 P2P 릴레이 아키텍처는 웹앱과 풀노드 간의 동적 연결을 가능하게 합니다. 더 이상 웹앱을 재배포할 필요 없이 누구나 풀노드를 실행하여 네트워크에 참여할 수 있습니다.

## 아키텍처 구성

### 1. 릴레이 서버 (중앙 중계점)
- **위치**: Railway 클라우드 (고정 URL)
- **역할**:
  - 풀노드 등록 및 관리
  - 사용자 연결 관리
  - 로드 밸런싱
  - WebSocket/HTTP 요청 중계

### 2. 풀노드 (검증자 노드)
- **위치**: 개인 컴퓨터, 서버 등
- **역할**:
  - 블록체인 검증
  - 트랜잭션 처리
  - 데이터 저장
  - 릴레이 서버에 자동 등록

### 3. 웹앱 (사용자 인터페이스)
- **위치**: Vercel (정적 호스팅)
- **역할**:
  - 사용자 인터페이스 제공
  - 릴레이 서버를 통해 풀노드와 통신

## 동작 흐름

### 풀노드 시작 및 등록
```
1. 풀노드 시작
   ↓
2. 릴레이 서버에 WebSocket 연결
   ↓
3. 노드 정보 등록 (ID, endpoint, capabilities)
   ↓
4. 주기적 ping으로 상태 유지
```

### 사용자 연결
```
1. 웹앱에서 로그인
   ↓
2. 릴레이 서버에 WebSocket 연결
   ↓
3. 릴레이 서버가 사용 가능한 풀노드 할당
   ↓
4. 모든 요청이 릴레이 서버를 통해 라우팅
```

## 설정 방법

### 1. 릴레이 서버 배포
```bash
# Railway에 릴레이 서버 배포
./deploy-relay.ps1
```

### 2. 풀노드 실행
```bash
# 릴레이 서버 URL 설정 (환경변수)
$env:RELAY_SERVER_URL = "wss://baekya-relay.up.railway.app"

# 풀노드 시작
./start-validator.ps1
```

### 3. 웹앱 설정
웹앱은 자동으로 릴레이 서버와 연결됩니다. 필요시 `public/config.js`에서 URL을 수정할 수 있습니다:

```javascript
window.RELAY_SERVER_URL = 'https://baekya-relay.up.railway.app';
```

## 장점

1. **동적 확장성**: 풀노드가 자동으로 네트워크에 참여
2. **재배포 불필요**: 웹앱 재배포 없이 풀노드 추가/제거 가능
3. **로드 밸런싱**: 릴레이 서버가 자동으로 부하 분산
4. **고가용성**: 여러 풀노드 중 하나가 다운되어도 서비스 지속
5. **보안성**: 풀노드가 직접 인터넷에 노출되지 않음

## 환경 변수

### 릴레이 서버
- `PORT`: 서버 포트 (Railway가 자동 설정)
- `NODE_ENV`: production

### 풀노드
- `RELAY_SERVER_URL`: 릴레이 서버 WebSocket URL
- `DIRECT_MODE`: true로 설정시 릴레이 서버 사용 안함

## 모니터링

### 릴레이 서버 상태 확인
```
GET https://baekya-relay.up.railway.app/api/relay-status
```

### 등록된 노드 확인
```
GET https://baekya-relay.up.railway.app/api/nodes
```

## 문제 해결

### 풀노드가 연결되지 않을 때
1. 릴레이 서버 URL이 올바른지 확인
2. 방화벽/프록시 설정 확인
3. WebSocket 연결이 가능한지 확인

### 웹앱이 연결되지 않을 때
1. 브라우저 콘솔에서 오류 확인
2. 릴레이 서버가 실행 중인지 확인
3. CORS 설정 확인

## 보안 고려사항

1. **TLS/SSL**: 모든 통신은 암호화됨
2. **인증**: DID 기반 인증
3. **세션 관리**: 중복 로그인 방지
4. **DOS 방어**: 릴레이 서버에서 rate limiting 적용 